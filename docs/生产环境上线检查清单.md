# AnesGuardian 生产环境上线检查清单

**项目：** 麻醉守护神 (AnesGuardian) v2.1.0
**检查日期：** ________
**负责人：** ________
**预计上线时间：** ________

---

## ✅ 使用说明

本检查清单覆盖生产环境部署前必须验证的所有关键项目。

**检查规则：**
- ✅ = 已完成并验证
- ⚠️ = 部分完成或有问题
- ❌ = 未完成
- N/A = 不适用

**上线标准：**
- 所有🔴标记项必须为✅
- 🟠标记项至少80%为✅
- 🟡标记项建议完成但不阻塞上线

---

## 1. 环境配置 🔴

### 1.1 环境变量配置

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| `.env`文件存在且配置完整 | 🔴 | ☐ | 对照`.env.example`检查 |  |
| `GEMINI_API_KEY`已配置 | 🔴 | ☐ | 测试API调用 |  |
| `DATABASE_URL`已配置 | 🔴 | ☐ | 测试数据库连接 |  |
| `NODE_ENV=production`已设置 | 🔴 | ☐ | `echo $NODE_ENV` |  |
| `SESSION_SECRET`已设置为强随机值 | 🔴 | ☐ | 长度≥32字符 |  |
| `ALLOWED_ORIGINS`已配置生产域名 | 🔴 | ☐ | 测试CORS |  |
| `PORT`已配置（默认3001） | 🟡 | ☐ | 确认端口可用 |  |
| 所有敏感信息不在代码中硬编码 | 🔴 | ☐ | 代码审查 |  |

**验证命令：**
```bash
# 检查环境变量
node -e "require('dotenv').config(); console.log({
  GEMINI_API_KEY: process.env.GEMINI_API_KEY ? '已配置' : '❌未配置',
  DATABASE_URL: process.env.DATABASE_URL ? '已配置' : '❌未配置',
  NODE_ENV: process.env.NODE_ENV || '❌未配置',
  SESSION_SECRET: process.env.SESSION_SECRET ? '已配置' : '❌未配置'
})"
```

---

### 1.2 服务器环境

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| Node.js版本≥18.0.0 | 🔴 | ☐ | `node --version` |  |
| npm版本≥9.0.0 | 🟡 | ☐ | `npm --version` |  |
| 服务器内存≥2GB | 🔴 | ☐ | `free -h` |  |
| 磁盘空间≥10GB可用 | 🔴 | ☐ | `df -h` |  |
| PostgreSQL 14+可访问 | 🔴 | ☐ | `psql --version` |  |

---

## 2. 数据库 🔴

### 2.1 数据库配置

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 数据库已创建 | 🔴 | ☐ | 连接测试 |  |
| Schema已推送到数据库 | 🔴 | ☐ | `npm run db:push` |  |
| 所有表已创建 | 🔴 | ☐ | 查询表列表 |  |
| 索引已创建 | 🟠 | ☐ | 查询索引列表 |  |
| 药物数据已导入（318种） | 🔴 | ☐ | `SELECT COUNT(*) FROM drugs` |  |
| 数据库连接池已配置 | 🟡 | ☐ | 检查db.ts配置 |  |

**验证命令：**
```bash
# 检查数据库表
psql $DATABASE_URL -c "\dt"

# 检查药物数据
psql $DATABASE_URL -c "SELECT COUNT(*) FROM drugs"

# 检查索引
psql $DATABASE_URL -c "SELECT tablename, indexname FROM pg_indexes WHERE schemaname='public'"
```

**预期表：**
- [ ] patients
- [ ] assessments
- [ ] agent_logs
- [ ] drugs
- [ ] medical_reports

---

### 2.2 数据备份

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 备份脚本已准备 | 🔴 | ☐ | 测试运行 |  |
| 自动备份已配置 | 🟠 | ☐ | 检查cron任务 |  |
| 备份恢复已测试 | 🟠 | ☐ | 恢复测试 |  |
| 备份存储位置已确定 | 🔴 | ☐ | 文档记录 |  |

---

## 3. 安全性 🔴

### 3.1 API安全

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 所有API端点有速率限制 | 🔴 | ☐ | 超限测试 |  |
| AI端点有特殊速率限制（10次/分钟） | 🔴 | ☐ | 测试AI端点 |  |
| 文件上传有限制（5次/分钟，10MB） | 🔴 | ☐ | 上传测试 |  |
| 统一错误处理已启用 | 🔴 | ☐ | 触发各种错误 |  |
| 错误信息不泄露敏感细节 | 🔴 | ☐ | 查看错误响应 |  |
| 输入验证和清理已实施 | 🔴 | ☐ | XSS/注入测试 |  |

**测试速率限制：**
```bash
# 测试全局速率限制（应在100次后返回429）
for i in {1..110}; do
  curl -w "%{http_code}\n" http://your-domain.com/api/patients
done | grep 429

# 测试AI端点限制（应在10次后返回429）
for i in {1..15}; do
  curl -X POST http://your-domain.com/api/patients/1/assess
done
```

---

### 3.2 数据传输安全

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| HTTPS已启用 | 🔴 | ☐ | 浏览器地址栏🔒 |  |
| HTTP强制重定向到HTTPS | 🔴 | ☐ | 访问http://测试 |  |
| SSL证书有效 | 🔴 | ☐ | 证书检查 |  |
| HSTS已启用 | 🟠 | ☐ | 检查响应headers |  |
| Helmet中间件已启用 | 🔴 | ☐ | 检查security headers |  |
| CSP已配置 | 🟠 | ☐ | 检查Content-Security-Policy |  |

**检查Security Headers：**
```bash
curl -I https://your-domain.com | grep -E "Strict-Transport-Security|X-Content-Type-Options|X-Frame-Options|Content-Security-Policy"
```

**预期Headers：**
```
Strict-Transport-Security: max-age=31536000; includeSubDomains
X-Content-Type-Options: nosniff
X-Frame-Options: DENY
Content-Security-Policy: default-src 'self'
```

---

### 3.3 认证和授权

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| Session配置安全（secure, httpOnly, sameSite） | 🔴 | ☐ | 检查cookie设置 |  |
| 敏感操作需要认证 | 🔴 | ☐ | 未登录访问测试 |  |
| CORS配置严格限制源 | 🔴 | ☐ | 跨域请求测试 |  |
| 患者数据访问有权限检查 | 🟠 | ☐ | 越权测试 |  |

---

### 3.4 敏感数据保护

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 患者隐私信息已标记 | 🟠 | ☐ | 代码审查 |  |
| 日志中敏感信息已脱敏 | 🔴 | ☐ | 检查日志文件 |  |
| 环境变量安全存储 | 🔴 | ☐ | 检查.env不在版本控制 |  |
| API响应不包含内部错误详情 | 🔴 | ☐ | 生产环境错误测试 |  |

---

## 4. 监控和日志 🔴

### 4.1 日志系统

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| Winston日志已配置 | 🔴 | ☐ | 检查logs/目录 |  |
| 日志文件轮转已启用（每日） | 🟠 | ☐ | 等待24小时验证 |  |
| 错误日志记录完整 | 🔴 | ☐ | 触发错误检查日志 |  |
| API请求日志记录 | 🟠 | ☐ | 发送请求检查日志 |  |
| AI调用日志记录 | 🟠 | ☐ | 调用AI检查日志 |  |
| 慢请求警告已配置（>5秒） | 🟡 | ☐ | 检查日志配置 |  |

**验证日志：**
```bash
# 检查日志目录
ls -lh logs/

# 查看最新错误日志
tail -f logs/error-*.log

# 查看综合日志
tail -f logs/combined-*.log
```

---

### 4.2 健康检查

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| `/health`端点返回200 | 🔴 | ☐ | `curl /health` |  |
| `/health/detailed`显示所有服务状态 | 🔴 | ☐ | `curl /health/detailed` |  |
| 数据库连接检查正常 | 🔴 | ☐ | 检查detailed响应 |  |
| Gemini API连接检查正常 | 🔴 | ☐ | 检查detailed响应 |  |
| 内存使用监控 | 🟡 | ☐ | 检查detailed响应 |  |

**预期响应：**
```json
{
  "status": "healthy",
  "timestamp": "2025-11-05T10:00:00.000Z",
  "uptime": 3600,
  "services": {
    "database": { "status": "healthy", "type": "PostgreSQL" },
    "geminiAPI": { "status": "healthy" }
  },
  "memory": {
    "heapUsed": "120MB",
    "heapTotal": "180MB"
  }
}
```

---

### 4.3 监控指标

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| `/metrics`端点可访问 | 🟠 | ☐ | `curl /metrics` |  |
| API响应时间统计 | 🟠 | ☐ | 检查metrics响应 |  |
| 错误率统计 | 🟠 | ☐ | 检查metrics响应 |  |
| AI调用成功率统计 | 🟠 | ☐ | 检查metrics响应 |  |

---

### 4.4 告警系统

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 错误率告警已配置 | 🟡 | ☐ | 触发高错误率 |  |
| 告警通知渠道已配置 | 🟡 | ☐ | 测试通知 |  |
| 告警冷却时间已设置 | 🟡 | ☐ | 检查代码配置 |  |

---

## 5. 测试 🟠

### 5.1 测试覆盖率

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 单元测试覆盖率≥30% | 🟠 | ☐ | `npm run test:coverage` |  |
| Schema验证测试通过 | 🔴 | ☐ | `npm run test` |  |
| 风险评估逻辑测试通过 | 🔴 | ☐ | 查看测试结果 |  |
| API集成测试通过 | 🟠 | ☐ | 查看测试结果 |  |
| E2E测试通过 | 🟡 | ☐ | `npm run test:e2e` |  |

**运行测试：**
```bash
# 运行所有测试
npm run test

# 查看覆盖率
npm run test:coverage

# 运行E2E测试
npm run test:e2e
```

---

### 5.2 功能测试

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 患者创建功能正常 | 🔴 | ☐ | 手动测试 |  |
| 风险评估流程正常 | 🔴 | ☐ | 完整流程测试 |  |
| 药物相互作用分析正常 | 🔴 | ☐ | 测试多种药物组合 |  |
| 医疗报告上传和分析正常 | 🔴 | ☐ | 上传测试图片 |  |
| AI问答功能正常 | 🟠 | ☐ | 测试多个问题 |  |
| 临床指南检索正常 | 🟡 | ☐ | 搜索测试 |  |

---

## 6. 性能 🟠

### 6.1 前端性能

| 检查项 | 优先级 | 状态 | 验证方法 | 目标 | 实际 |
|--------|--------|------|----------|------|------|
| 首屏加载时间（FCP） | 🟠 | ☐ | Lighthouse | <2秒 | ___秒 |
| 最大内容绘制（LCP） | 🟠 | ☐ | Lighthouse | <2.5秒 | ___秒 |
| 首次输入延迟（FID） | 🟡 | ☐ | Lighthouse | <100ms | ___ms |
| Lighthouse性能分数 | 🟠 | ☐ | Lighthouse | ≥85 | ___ |
| Bundle大小 | 🟡 | ☐ | Build输出 | <2MB | ___MB |

**运行Lighthouse：**
```bash
npm run build
npm start
# 在Chrome DevTools中运行Lighthouse
```

---

### 6.2 后端性能

| 检查项 | 优先级 | 状态 | 验证方法 | 目标 | 实际 |
|--------|--------|------|----------|------|------|
| API平均响应时间 | 🟠 | ☐ | /metrics端点 | <500ms | ___ms |
| 数据库查询时间 | 🟡 | ☐ | 日志分析 | <100ms | ___ms |
| AI服务响应时间 | 🟡 | ☐ | 日志分析 | <5秒 | ___秒 |
| 95百分位响应时间 | 🟡 | ☐ | 压力测试 | <2秒 | ___秒 |

**压力测试：**
```bash
# 安装autocannon
npm install -g autocannon

# 简单压力测试
autocannon -c 10 -d 30 http://your-domain.com/api/patients
```

---

### 6.3 优化检查

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 路由懒加载已实施 | 🟡 | ☐ | 检查App.tsx |  |
| React Query缓存已配置 | 🟡 | ☐ | 检查queryClient.ts |  |
| 数据库索引已创建 | 🟠 | ☐ | 查询索引列表 |  |
| 静态资源有缓存（药物数据） | 🟡 | ☐ | 检查响应headers |  |
| 图片懒加载已实施 | 🟡 | ☐ | 检查img标签 |  |

---

## 7. 代码质量 🟡

### 7.1 代码规范

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| ESLint检查通过 | 🟡 | ☐ | `npm run lint` |  |
| Prettier格式化完成 | 🟡 | ☐ | `npm run format` |  |
| TypeScript编译通过 | 🔴 | ☐ | `npm run check` |  |
| 无console.log残留（生产环境） | 🟡 | ☐ | 搜索代码 |  |
| Pre-commit hooks已配置 | 🟡 | ☐ | 测试提交 |  |

**代码检查：**
```bash
# TypeScript检查
npm run check

# Lint检查
npm run lint

# 格式化
npm run format
```

---

### 7.2 Agents审查

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| medical-safety-auditor审查通过 | 🔴 | ☐ | 运行agent |  |
| api-security-reviewer审查通过 | 🔴 | ☐ | 运行agent |  |
| performance-optimizer无严重问题 | 🟠 | ☐ | 运行agent |  |
| test-coverage-guardian无严重缺失 | 🟠 | ☐ | 运行agent |  |
| ai-integration-validator无严重问题 | 🟡 | ☐ | 运行agent |  |

---

## 8. 部署配置 🟠

### 8.1 构建和启动

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| `npm run build`成功 | 🔴 | ☐ | 运行构建 |  |
| `npm start`成功启动 | 🔴 | ☐ | 启动测试 |  |
| 构建产物在dist/目录 | 🔴 | ☐ | 检查文件 |  |
| 无构建警告或错误 | 🟡 | ☐ | 查看构建日志 |  |

---

### 8.2 Docker部署

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| Dockerfile已创建 | 🟠 | ☐ | 文件存在 |  |
| docker-compose.yml已创建 | 🟠 | ☐ | 文件存在 |  |
| Docker镜像构建成功 | 🟠 | ☐ | `docker build -t anesthesia-guardian .` |  |
| docker-compose启动成功 | 🟠 | ☐ | `docker-compose up -d` |  |
| 健康检查在Docker中正常 | 🟠 | ☐ | `docker ps` 查看健康状态 |  |

**Docker测试：**
```bash
# 构建镜像
docker build -t anesthesia-guardian .

# 启动服务
docker-compose up -d

# 检查健康状态
docker ps
curl http://localhost:3001/health
```

---

### 8.3 部署脚本

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 部署脚本已创建 | 🟡 | ☐ | scripts/deploy.sh存在 |  |
| 备份脚本已创建 | 🟠 | ☐ | scripts/backup-db.sh存在 |  |
| 部署文档已完成 | 🟠 | ☐ | docs/生产环境部署指南.md |  |
| 回滚方案已准备 | 🟠 | ☐ | 文档记录 |  |

---

## 9. 文档 🟡

### 9.1 必要文档

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| README.md已更新 | 🟡 | ☐ | 查看文件 |  |
| CHANGELOG.md已更新 | 🟡 | ☐ | 记录v2.1.0变更 |  |
| 环境变量说明（.env.example） | 🔴 | ☐ | 文件完整 |  |
| 生产环境部署指南 | 🟠 | ☐ | 文档完整 |  |
| 故障排查指南 | 🟡 | ☐ | 文档准备 |  |

---

### 9.2 运维文档

| 检查项 | 优先级 | 状态 | 验证方法 | 备注 |
|--------|--------|------|----------|------|
| 备份和恢复流程文档 | 🟠 | ☐ | 文档记录 |  |
| 日志查询和分析指南 | 🟡 | ☐ | 文档记录 |  |
| 紧急联系人信息 | 🟡 | ☐ | 文档记录 |  |
| 常见问题FAQ | 🟡 | ☐ | 文档记录 |  |

---

## 10. 最终检查 🔴

### 10.1 关键功能验证

完成以下完整用户流程测试：

**流程1: 患者创建→评估→报告**
- [ ] 创建新患者（手动输入）
- [ ] 创建新患者（上传医疗记录）
- [ ] 启动风险评估
- [ ] 等待评估完成（所有6个代理完成）
- [ ] 查看评估报告
- [ ] 下载PDF报告

**流程2: 药物相互作用分析**
- [ ] 搜索药物
- [ ] 添加多个药物
- [ ] 查看相互作用分析
- [ ] 查看详细药理学解释
- [ ] 获取术前停药建议

**流程3: AI医疗问答**
- [ ] 提出医疗问题
- [ ] 获得AI回复
- [ ] 验证回复质量
- [ ] 测试重试机制（长回复）

---

### 10.2 安全扫描

| 检查项 | 优先级 | 状态 | 工具 | 备注 |
|--------|--------|------|------|------|
| npm依赖漏洞扫描 | 🔴 | ☐ | `npm audit` |  |
| 无高危或严重漏洞 | 🔴 | ☐ | npm audit结果 |  |
| OWASP ZAP扫描（可选） | 🟡 | ☐ | ZAP工具 |  |

**安全扫描：**
```bash
# npm依赖审计
npm audit

# 修复可自动修复的漏洞
npm audit fix

# 查看详细报告
npm audit --json
```

---

### 10.3 性能基准测试

**记录基准性能数据：**

| 指标 | 目标 | 实际 | 是否达标 |
|------|------|------|----------|
| 首屏加载时间 | <2秒 | ___秒 | ☐ |
| API平均响应 | <500ms | ___ms | ☐ |
| 患者创建API | <300ms | ___ms | ☐ |
| 风险评估时间 | <10秒 | ___秒 | ☐ |
| AI问答响应 | <5秒 | ___秒 | ☐ |
| 数据库查询 | <100ms | ___ms | ☐ |

---

## 🎯 上线决策

### 关键指标汇总

| 类别 | 完成率 | 是否达标 | 备注 |
|------|--------|----------|------|
| 🔴 P0任务 | ___% | ☐ | 必须100% |
| 🟠 P1任务 | ___% | ☐ | 建议≥80% |
| 🟡 P2任务 | ___% | ☐ | 建议≥50% |

### 上线评估

**✅ 可以上线 - 满足以下所有条件：**
- [ ] 所有🔴标记项100%完成
- [ ] 🟠标记项≥80%完成
- [ ] 关键功能测试全部通过
- [ ] 性能指标达标
- [ ] 无高危安全漏洞
- [ ] 监控和日志系统正常
- [ ] 备份和回滚方案已准备

**⚠️ 需改进 - 存在以下情况：**
- [ ] 🔴项有未完成
- [ ] 🟠项完成率<80%
- [ ] 关键功能有问题
- [ ] 性能未达标

**❌ 不可上线 - 存在严重问题：**
- [ ] 多个🔴项未完成
- [ ] 关键安全问题未解决
- [ ] 核心功能无法使用
- [ ] 数据安全有风险

---

## 📅 上线计划

### 上线时间表

| 阶段 | 时间 | 负责人 | 状态 |
|------|------|--------|------|
| 最终测试 | ________ | ________ | ☐ |
| 数据备份 | ________ | ________ | ☐ |
| 部署到生产 | ________ | ________ | ☐ |
| 健康检查 | ________ | ________ | ☐ |
| 监控观察 | ________ | ________ | ☐ |

### 上线团队

| 角色 | 姓名 | 联系方式 | 职责 |
|------|------|----------|------|
| 负责人 |  |  | 总体协调 |
| 开发 |  |  | 技术支持 |
| 运维 |  |  | 部署和监控 |
| 测试 |  |  | 功能验证 |

### 上线后监控

**前24小时重点监控：**
- [ ] 每小时检查健康状态
- [ ] 监控错误日志
- [ ] 关注API响应时间
- [ ] 检查AI服务成功率
- [ ] 验证数据库性能

**前1周监控计划：**
- [ ] 每日健康检查
- [ ] 分析用户反馈
- [ ] 性能指标跟踪
- [ ] 错误率统计

---

## 🚨 应急预案

### 回滚方案

**回滚触发条件：**
- 严重功能故障影响核心业务
- 数据安全问题
- 性能严重降级（响应时间>10秒）
- 错误率>50%

**回滚步骤：**
```bash
# 1. 停止服务
docker-compose down

# 2. 恢复数据库（如有数据变更）
psql $DATABASE_URL < backup/anesthesia_guardian_backup.sql

# 3. 切换到上一版本代码
git checkout <previous_version_tag>

# 4. 重新部署
./scripts/deploy.sh

# 5. 验证服务
curl http://localhost:3001/health
```

### 紧急联系

| 问题类型 | 联系人 | 联系方式 | 响应时间 |
|---------|--------|----------|----------|
| 技术故障 |  |  | 30分钟 |
| 数据库问题 |  |  | 1小时 |
| AI服务问题 |  |  | 2小时 |
| 安全事件 |  |  | 立即 |

---

## ✅ 检查清单完成确认

**检查人：** ________
**检查日期：** ________

**总体评估：**
- 🔴 P0任务完成：___ / ___ (___%)
- 🟠 P1任务完成：___ / ___ (___%)
- 🟡 P2任务完成：___ / ___ (___%)

**上线决定：** ☐ 批准上线 | ☐ 需要改进 | ☐ 暂不上线

**批准人签名：** ________
**批准日期：** ________

---

**上线成功后记得：**
1. 更新CHANGELOG.md
2. 创建git tag标记版本
3. 通知相关人员
4. 记录经验教训
5. 规划下一阶段优化

**祝上线顺利！** 🚀
