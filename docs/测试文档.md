# 测试文档

## 测试框架

使用 **Vitest** 作为测试框架（最适合Vite项目）

### 安装的依赖

```bash
npm install --save-dev vitest @vitest/ui @vitest/coverage-v8 @testing-library/react @testing-library/jest-dom happy-dom
```

### 测试命令

```bash
npm run test              # 运行所有测试
npm run test:ui           # 打开Vitest UI界面
npm run test:coverage     # 生成测试覆盖率报告
```

## 测试结构

```
tests/
├── setup.ts                    # 测试环境配置
├── unit/                       # 单元测试
│   ├── utils/
│   │   ├── audit-logger.test.ts        # 审计日志测试
│   │   ├── permission-cache.test.ts    # 权限缓存测试
│   │   ├── rbac.test.ts               # RBAC工具测试
│   │   └── sanitize.test.ts           # 输入清理测试
│   ├── middleware/
│   │   ├── auth.test.ts               # 认证中间件测试
│   │   └── permission.test.ts         # 权限中间件测试
│   └── services/
│       └── simple-agents.test.ts      # 多Agent系统测试
├── integration/                # 集成测试
│   ├── auth-flow.test.ts          # 完整认证流程测试
│   ├── patient-crud.test.ts        # 患者CRUD集成测试
│   └── permission-flow.test.ts     # 权限检查流程测试
└── security/                   # 安全测试
    ├── permission-escalation.test.ts  # 权限提升攻击测试
    ├── sql-injection.test.ts          # SQL注入防护测试
    └── xss-protection.test.ts         # XSS防护测试
```

## 阶段5.1: 单元测试（已完成）

### audit-logger.test.ts

测试审计日志系统的所有核心功能：

✅ **基本日志记录**
- 记录审计日志并包含timestamp
- 限制内存中日志数量（maxLogs = 10000）
- 生产环境输出JSON格式

✅ **专用日志方法**
- `logAuth()` - 认证事件（login, logout, auth_failure）
- `logPermissionCheck()` - 权限检查（成功/失败）
- `logDataAccess()` - 数据访问（view, create, update, delete, share）
- `logSensitiveOperation()` - 敏感操作（带详细信息）

✅ **日志查询**
- 按userId过滤
- 按action过滤
- 按resource过滤
- 按status过滤
- 按时间范围过滤
- 限制返回数量
- 按时间倒序排列

✅ **统计功能**
- 总日志数
- 成功/失败次数
- 按操作类型统计
- 按资源类型统计
- 按用户统计
- 支持时间范围统计

✅ **日志清理**
- 清除超过指定天数的旧日志
- 保留指定天数内的日志

**测试覆盖率**: ~100%

### permission-cache.test.ts

测试权限缓存系统（LRU + TTL）：

✅ **基本缓存操作**
- 存储和获取权限（true/false）
- 不存在的键返回undefined
- 区分不同的缓存键（userId + resource + resourceId + action）
- 区分不同的操作类型

✅ **TTL（过期时间）**
- 5分钟后自动过期
- 过期前可以正常获取
- 使用fake timers测试时间控制

✅ **LRU淘汰策略**
- 最久未使用的项优先淘汰
- 访问时刷新LRU位置
- 最大容量：1000项

✅ **缓存失效**
- `invalidateUser()` - 使用户的所有权限缓存失效
- `invalidateResource()` - 使资源的所有权限缓存失效
- `clear()` - 清空所有缓存

✅ **统计信息**
- 缓存大小
- 最大容量
- 使用率百分比
- TTL时间

✅ **用户会话缓存（UserSessionCache）**
- 存储和获取用户会话数据
- 删除用户会话
- 5分钟TTL
- 最大容量：500项
- 正确处理可选字段（organizationId, displayName）

✅ **缓存独立性**
- 权限缓存和用户会话缓存独立工作
- 清空一个不影响另一个

**测试覆盖率**: ~100%

## 阶段5.2: 集成测试（待实施）

### auth-flow.test.ts

完整认证流程测试：
- [ ] Supabase JWT验证
- [ ] 用户信息查询/创建
- [ ] 会话缓存工作流
- [ ] 审计日志记录

### patient-crud.test.ts

患者CRUD集成测试：
- [ ] 创建患者（含权限检查）
- [ ] 查询患者（权限过滤）
- [ ] 更新患者（创建者/组织成员权限）
- [ ] 删除患者（管理员/创建者医生权限）
- [ ] 共享患者（创建者/管理员权限）
- [ ] 取消共享

### permission-flow.test.ts

权限检查流程测试：
- [ ] checkPatientAccess中间件
- [ ] 权限缓存命中/未命中
- [ ] RBAC规则验证
- [ ] 缓存失效流程

## 阶段5.3: 安全测试（待实施）

### permission-escalation.test.ts

权限提升攻击测试：
- [ ] 护士尝试创建患者（应失败）
- [ ] 普通用户尝试删除患者（应失败）
- [ ] 用户尝试访问未共享的患者（应失败）
- [ ] 跨组织访问尝试（应失败）

### sql-injection.test.ts

SQL注入防护测试：
- [ ] 输入过滤（sanitizeInput）
- [ ] Drizzle ORM参数化查询
- [ ] 特殊字符处理

### xss-protection.test.ts

XSS防护测试：
- [ ] HTML标签过滤
- [ ] JavaScript注入防护
- [ ] 输出转义验证

## 测试最佳实践

### 1. 使用describe和it组织测试

```typescript
describe('AuditLogger', () => {
  describe('log()', () => {
    it('应该记录基本审计日志', () => {
      // 测试代码
    });
  });
});
```

### 2. beforeEach清理状态

```typescript
beforeEach(() => {
  auditLogger['logs'] = [];
  vi.spyOn(console, 'log').mockImplementation(() => {});
});
```

### 3. 使用fake timers测试TTL

```typescript
beforeEach(() => {
  vi.useFakeTimers();
});

afterEach(() => {
  vi.useRealTimers();
});

it('应该在5分钟后过期', () => {
  cache.set(key, value);
  vi.advanceTimersByTime(5 * 60 * 1000); // 前进5分钟
  expect(cache.get(key)).toBeUndefined();
});
```

### 4. Mock外部依赖

```typescript
vi.mock('../../../server/db', () => ({
  db: {
    select: vi.fn(),
    insert: vi.fn(),
    update: vi.fn(),
    delete: vi.fn(),
  },
}));
```

### 5. 测试边界条件

```typescript
// 测试空输入
// 测试最大值/最小值
// 测试过期时间
// 测试并发情况
```

## 持续集成

未来可以添加GitHub Actions或CI/CD流程：

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: 20
      - run: npm install
      - run: npm run test
      - run: npm run test:coverage
```

## 测试覆盖率目标

- **核心工具类**: 100%
- **中间件**: >90%
- **API路由**: >80%
- **整体项目**: >75%

## 当前进度

- ✅ 阶段5.1: 单元测试 - audit-logger, permission-cache
- ⏳ 阶段5.2: 集成测试
- ⏳ 阶段5.3: 安全测试
