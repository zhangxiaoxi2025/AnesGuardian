# AnesGuardian 安全配置文档

**创建日期：** 2025-11-08
**版本：** v2.1.1
**状态：** Week 1 安全加固已完成

---

## 📋 概述

本文档记录了AnesGuardian项目在Week 1实施的安全加固措施，包括速率限制、输入验证、安全头部配置等关键安全功能。

---

## 🔒 已实施的安全措施

### 1. 速率限制（Rate Limiting）

#### 全局API速率限制
- **限制：** 每个IP 100次请求/15分钟
- **应用范围：** 所有API端点
- **配置文件：** `server/middleware/rate-limit.ts`
- **响应代码：** 429 (Too Many Requests)

#### AI服务专用速率限制
- **限制：** 每个IP 10次请求/分钟
- **应用端点：**
  - `/api/patients/:id/assess` - 患者风险评估
  - `/api/chat` - AI聊天服务
  - `/api/medical-reports/analyze` - 医疗报告分析
  - `/api/interactions/analyze` - 药物相互作用分析
- **原因：** AI服务调用成本高，需要更严格控制

#### 文件上传速率限制
- **限制：** 每个IP 5次上传/分钟
- **应用端点：** `/api/medical-reports/upload`
- **原因：** 防止大量文件上传攻击

#### 登录速率限制
- **限制：** 每个IP 5次尝试/15分钟
- **特性：** 成功的登录不计入限制
- **原因：** 防止暴力破解攻击

---

### 2. 安全头部配置（Helmet）

#### 已启用的安全头部
- **X-Content-Type-Options:** nosniff
- **X-Frame-Options:** DENY
- **X-XSS-Protection:** 1; mode=block
- **Referrer-Policy:** strict-origin-when-cross-origin

#### Content Security Policy (CSP)
```javascript
{
  defaultSrc: ["'self'"],
  scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'"],
  styleSrc: ["'self'", "'unsafe-inline'", "https:"],
  imgSrc: ["'self'", "data:", "https:", "blob:"],
  fontSrc: ["'self'", "data:", "https:"],
  connectSrc: ["'self'", "https://generativelanguage.googleapis.com", "wss:"],
  frameSrc: ["'self'"],
  objectSrc: ["'none'"]
}
```

#### HSTS（仅生产环境）
- **maxAge:** 31536000 (1年)
- **includeSubDomains:** true
- **preload:** true

---

### 3. CORS配置强化

#### 允许的源（Origin）
- **开发环境默认：**
  - `http://localhost:5173` (Vite开发服务器)
  - `http://localhost:5000` (Express服务器)
  - `http://localhost:3000` (备用端口)

- **生产环境：**
  - 通过环境变量 `ALLOWED_ORIGINS` 配置
  - 多个域名用逗号分隔

#### CORS设置
- **credentials:** true (允许发送cookies)
- **methods:** GET, POST, PATCH, DELETE, PUT, OPTIONS
- **allowedHeaders:** Content-Type, Authorization, X-Requested-With, Accept
- **exposedHeaders:** RateLimit-Limit, RateLimit-Remaining, RateLimit-Reset

---

### 4. 输入验证与清理

#### 实施的验证
| 验证类型 | 实施位置 | 说明 |
|---------|---------|------|
| XSS防护 | `server/utils/sanitize.ts` | 移除script、iframe等危险标签 |
| SQL注入防护 | Drizzle ORM + sanitize | 参数化查询 + 额外清理 |
| 文件类型验证 | Multer配置 | 仅允许JPG、PNG、GIF图片 |
| 文件大小限制 | Multer配置 | 最大10MB |
| 文件名清理 | `sanitizeFilename()` | 移除特殊字符，防止目录遍历 |
| 邮箱验证 | `isValidEmail()` | 正则表达式验证 |
| 手机号验证 | `isValidPhone()` | 中国大陆号码格式 |

#### 输入清理函数
```typescript
// 字符串清理
sanitizeString(input: string)

// 对象递归清理
sanitizeInput(input: any)

// 文件名清理
sanitizeFilename(filename: string)

// SQL输入清理
sanitizeSQLInput(input: string)

// HTML清理
sanitizeHTML(html: string)
```

---

### 5. 统一错误处理

#### 自定义错误类
| 错误类 | HTTP状态码 | 错误代码 | 使用场景 |
|--------|----------|---------|---------|
| ValidationError | 400 | VALIDATION_ERROR | 请求数据验证失败 |
| UnauthorizedError | 401 | UNAUTHORIZED | 未授权访问 |
| ForbiddenError | 403 | FORBIDDEN | 权限不足 |
| NotFoundError | 404 | NOT_FOUND | 资源不存在 |
| ConflictError | 409 | CONFLICT | 资源冲突 |
| RateLimitError | 429 | RATE_LIMIT_EXCEEDED | 超过速率限制 |
| InternalServerError | 500 | INTERNAL_ERROR | 服务器内部错误 |
| AIServiceError | 500 | AI_SERVICE_ERROR | AI服务调用失败 |
| FileUploadError | 400 | FILE_UPLOAD_ERROR | 文件上传失败 |

#### 错误响应格式
```json
{
  "status": "error",
  "code": "ERROR_CODE",
  "message": "用户友好的错误消息"
}
```

#### 错误处理特性
- ✅ 统一的错误响应格式
- ✅ 生产环境隐藏敏感信息
- ✅ 开发环境显示详细堆栈
- ✅ 自动记录错误日志
- ✅ 区分操作性错误和程序错误

---

### 6. 文件上传安全

#### Multer配置增强
```typescript
{
  storage: multer.memoryStorage(),
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MB
    files: 1 // 一次只能上传一个文件
  },
  fileFilter: (req, file, cb) => {
    // 验证文件类型
    if (!isAllowedFileType(file.mimetype)) {
      cb(new FileUploadError('只允许上传JPG、PNG格式的图片文件'));
      return;
    }
    // 清理文件名
    file.originalname = sanitizeFilename(file.originalname);
    cb(null, true);
  }
}
```

---

### 7. 环境变量验证增强

#### 必需环境变量
- `GEMINI_API_KEY` - Google Gemini AI API密钥
- `DATABASE_URL` - PostgreSQL数据库连接字符串

#### 生产环境额外要求
- `SESSION_SECRET` - 会话密钥（至少32个字符）
- `ALLOWED_ORIGINS` - CORS允许的源列表

#### 可选环境变量
- `NODE_ENV` - 运行环境 (development/production)
- `PORT` - 服务器端口 (默认: 5000)
- `LOG_LEVEL` - 日志级别 (默认: info)
- `ALERT_WEBHOOK_URL` - 告警webhook地址

---

## 🏗️ 文件结构

```
server/
├── middleware/
│   ├── rate-limit.ts          # 速率限制配置
│   ├── security.ts            # Helmet和CORS配置
│   └── error-handler.ts       # 全局错误处理
├── utils/
│   ├── sanitize.ts            # 输入清理工具
│   └── errors.ts              # 自定义错误类
├── index.ts                   # 主入口（已集成安全中间件）
└── routes.ts                  # 路由（已应用速率限制）
```

---

## 🔧 配置说明

### 1. 环境变量配置

**创建 `.env` 文件：**
```bash
cp .env.example .env
```

**必需配置：**
```env
GEMINI_API_KEY=your_gemini_api_key_here
DATABASE_URL=postgresql://user:password@host:port/database
```

**生产环境额外配置：**
```env
NODE_ENV=production
SESSION_SECRET=your-strong-random-secret-key-here
ALLOWED_ORIGINS=https://your-domain.com,https://www.your-domain.com
```

**生成强随机密钥：**
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 2. 安全中间件应用顺序

```typescript
// server/index.ts
app.use(securityHeaders);      // 1. 安全头部
app.use(cors(getCorsOptions)); // 2. CORS配置
app.use(apiLimiter);          // 3. 全局速率限制
app.use(express.json());      // 4. 请求体解析
// ... 路由 ...
app.use(notFoundHandler);     // 5. 404处理
app.use(errorHandler);        // 6. 全局错误处理
```

---

## ✅ 验收标准

### 安全功能测试清单

- [ ] **速率限制测试**
  - [ ] 超过全局限制时返回429状态码
  - [ ] AI端点限制正常工作
  - [ ] 文件上传限制正常工作
  - [ ] 错误消息清晰友好

- [ ] **CORS测试**
  - [ ] 允许的源可以正常访问
  - [ ] 未授权的源被拒绝
  - [ ] 预检请求正常工作

- [ ] **输入验证测试**
  - [ ] XSS攻击被阻止
  - [ ] 恶意文件名被清理
  - [ ] 文件类型验证生效
  - [ ] 文件大小限制生效

- [ ] **错误处理测试**
  - [ ] 所有错误有统一格式
  - [ ] 生产环境不暴露敏感信息
  - [ ] 错误代码正确分类

- [ ] **环境变量测试**
  - [ ] 缺少必需变量时启动失败
  - [ ] 生产环境配置检查通过

---

## 🚨 安全最佳实践

### 1. 永远不要
- ❌ 在日志中记录敏感信息（密码、密钥等）
- ❌ 在错误消息中暴露系统内部信息
- ❌ 使用弱会话密钥
- ❌ 在生产环境禁用安全头部
- ❌ 信任用户输入

### 2. 总是
- ✅ 验证和清理所有用户输入
- ✅ 使用参数化查询防止SQL注入
- ✅ 实施适当的速率限制
- ✅ 记录安全相关事件
- ✅ 保持依赖项更新

### 3. 定期检查
- 🔍 依赖项安全漏洞 (`npm audit`)
- 🔍 环境变量配置
- 🔍 日志中的异常模式
- 🔍 速率限制规则的有效性

---

## 📊 性能影响

### 中间件性能开销
| 中间件 | 平均延迟增加 | 内存开销 |
|--------|------------|---------|
| Helmet | < 1ms | 最小 |
| CORS | < 1ms | 最小 |
| Rate Limiting | 1-2ms | 低 (内存存储) |
| Input Sanitization | < 1ms | 最小 |
| **总计** | **~3-5ms** | **低** |

### 优化建议
- 对于高流量应用，考虑使用Redis作为速率限制存储
- 监控速率限制命中率，调整阈值
- 定期清理日志文件

---

## 🔄 后续计划

### Week 2: 错误处理完善
- [ ] 增强日志系统（Winston集成）
- [ ] 添加请求日志中间件
- [ ] 实施敏感数据脱敏

### Week 3-4: 监控和日志
- [ ] 结构化日志系统
- [ ] 健康检查端点
- [ ] 基础监控指标
- [ ] 告警机制

---

## 📝 更新日志

### v2.1.1 (2025-11-08) - Week 1完成
- ✅ 添加速率限制中间件
- ✅ 集成Helmet安全头部
- ✅ 强化CORS配置
- ✅ 实施输入验证和清理
- ✅ 统一错误处理机制
- ✅ 增强文件上传安全
- ✅ 环境变量验证增强

---

## 📞 支持

如遇安全问题或疑问：
1. 查看项目文档 `docs/`
2. 检查环境变量配置
3. 查看日志文件
4. 联系开发团队

---

**最后更新：** 2025-11-08
**维护者：** AnesGuardian 开发团队
