# Supabase é…ç½®æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨é…ç½® Supabase ä½œä¸º AnesGuardian çš„è®¤è¯å’Œæ•°æ®åº“æœåŠ¡ã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

- æœ‰æ•ˆçš„ç”µå­é‚®ç®±åœ°å€
- ç½‘ç»œè¿æ¥ï¼ˆéœ€è¦è®¿é—® supabase.comï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1: åˆ›å»º Supabase è´¦æˆ·å’Œé¡¹ç›®

1. **è®¿é—® Supabase**
   - æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—® [https://supabase.com](https://supabase.com)
   - ç‚¹å‡» "Start your project" æˆ– "Sign Up"

2. **æ³¨å†Œè´¦æˆ·**
   - ä½¿ç”¨ GitHubã€Google æˆ–é‚®ç®±æ³¨å†Œ
   - æ¨èä½¿ç”¨ GitHub ç™»å½•ï¼Œæ›´åŠ ä¾¿æ·

3. **åˆ›å»ºæ–°é¡¹ç›®**
   - ç‚¹å‡» "New Project"
   - å¡«å†™é¡¹ç›®ä¿¡æ¯ï¼š
     - **Name**: `anesthesia-guardian`ï¼ˆæˆ–æ‚¨å–œæ¬¢çš„åå­—ï¼‰
     - **Database Password**: è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ï¼ˆè¯·å¦¥å–„ä¿ç®¡ï¼‰
     - **Region**: é€‰æ‹© `Northeast Asia (Tokyo)` æˆ– `Southeast Asia (Singapore)`ï¼ˆç¦»ä¸­å›½è¾ƒè¿‘ï¼‰
   - ç‚¹å‡» "Create new project"
   - ç­‰å¾… 1-2 åˆ†é’Ÿè®©é¡¹ç›®åˆå§‹åŒ–å®Œæˆ

### æ­¥éª¤ 2: è·å– API å¯†é’¥

1. **è¿›å…¥é¡¹ç›®è®¾ç½®**
   - åœ¨é¡¹ç›®ä»ªè¡¨æ¿å·¦ä¾§ï¼Œç‚¹å‡» âš™ï¸ **Settings**
   - ç‚¹å‡» **API** é€‰é¡¹å¡

2. **å¤åˆ¶å¿…éœ€çš„å¯†é’¥**
   æ‚¨éœ€è¦å¤åˆ¶ä»¥ä¸‹ä¸¤ä¸ªå€¼ï¼š

   **â‘  Project URL**
   ```
   ç¤ºä¾‹: https://abcdefghijklmn.supabase.co
   ```
   
   **â‘¡ anon public key**ï¼ˆåœ¨ Project API keys éƒ¨åˆ†ï¼‰
   ```
   ç¤ºä¾‹: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...ï¼ˆå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼‰
   ```

### æ­¥éª¤ 3: é…ç½®ç¯å¢ƒå˜é‡

1. **æ‰“å¼€é¡¹ç›®æ ¹ç›®å½•çš„ `.env` æ–‡ä»¶**

2. **æ›´æ–° Supabase é…ç½®**
   æ‰¾åˆ°è¿™ä¸¤è¡Œï¼š
   ```bash
   VITE_SUPABASE_URL=your_supabase_project_url
   VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
   ```

3. **æ›¿æ¢ä¸ºæ‚¨çš„å®é™…å€¼**
   ```bash
   VITE_SUPABASE_URL=https://æ‚¨çš„é¡¹ç›®id.supabase.co
   VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...æ‚¨çš„å®Œæ•´å¯†é’¥
   ```

4. **ä¿å­˜æ–‡ä»¶**

### æ­¥éª¤ 4: é…ç½®è®¤è¯æä¾›å•†

#### å¯ç”¨ Email OTP è®¤è¯ï¼ˆé»˜è®¤å·²å¯ç”¨ï¼‰

1. åœ¨ Supabase é¡¹ç›®ä¸­ï¼Œç‚¹å‡»å·¦ä¾§ ğŸ” **Authentication**
2. ç‚¹å‡» **Providers** æ ‡ç­¾
3. æ‰¾åˆ° **Email** æä¾›å•†
4. ç¡®ä¿ **Enable Email provider** å·²å¼€å¯
5. **Enable Email OTP** ä¹Ÿéœ€è¦å¼€å¯

#### å¯é€‰ï¼šè‡ªå®šä¹‰é‚®ä»¶æ¨¡æ¿

1. åœ¨ Authentication é¡µé¢ï¼Œç‚¹å‡» **Email Templates**
2. é€‰æ‹© **Magic Link**
3. æ‚¨å¯ä»¥è‡ªå®šä¹‰é‚®ä»¶çš„ï¼š
   - ä¸»é¢˜ (Subject)
   - å†…å®¹ (Content)
   - æ·»åŠ æ‚¨çš„å“ç‰Œå…ƒç´ 

   ç¤ºä¾‹æ¨¡æ¿ï¼š
   ```html
   <h2>æ¬¢è¿ä½¿ç”¨ AnesGuardian</h2>
   <p>æ‚¨çš„éªŒè¯ç æ˜¯: {{ .Token }}</p>
   <p>æ­¤éªŒè¯ç å°†åœ¨ 5 åˆ†é’Ÿåè¿‡æœŸã€‚</p>
   ```

### æ­¥éª¤ 5: é…ç½®æ•°æ®åº“ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ‚¨æƒ³ä½¿ç”¨ Supabase ä½œä¸ºä¸»æ•°æ®åº“ï¼ˆæ›¿ä»£å½“å‰çš„ PostgreSQLï¼‰ï¼š

1. **è·å–æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²**
   - åœ¨ Supabase é¡¹ç›®ä¸­ï¼Œç‚¹å‡» âš™ï¸ **Settings** -> **Database**
   - æ‰¾åˆ° **Connection string** -> **URI**
   - å¤åˆ¶ "URI" æ ¼å¼çš„è¿æ¥å­—ç¬¦ä¸²

2. **æ›´æ–° `.env` æ–‡ä»¶**
   ```bash
   DATABASE_URL=postgresql://postgres:[YOUR-PASSWORD]@db.xxxxx.supabase.co:5432/postgres
   ```
   æ³¨æ„ï¼šå°† `[YOUR-PASSWORD]` æ›¿æ¢ä¸ºåˆ›å»ºé¡¹ç›®æ—¶è®¾ç½®çš„æ•°æ®åº“å¯†ç 

3. **è¿è¡Œæ•°æ®åº“è¿ç§»**
   ```bash
   npm run db:push
   ```

## ğŸ§ª æµ‹è¯•é…ç½®

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

### 2. è®¿é—®ç™»å½•é¡µé¢

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:3001/login`

### 3. æµ‹è¯•é‚®ç®±ç™»å½•

1. è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€
2. ç‚¹å‡» "å‘é€éªŒè¯ç "
3. æ£€æŸ¥æ‚¨çš„é‚®ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹ï¼‰
4. è¾“å…¥ 6 ä½éªŒè¯ç 
5. ç‚¹å‡» "éªŒè¯å¹¶ç™»å½•"

å¦‚æœæˆåŠŸï¼Œæ‚¨å°†è¢«é‡å®šå‘åˆ°ä¸»é¡µé¢ï¼

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: æ”¶ä¸åˆ°éªŒè¯ç é‚®ä»¶

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥åƒåœ¾é‚®ä»¶æ–‡ä»¶å¤¹
- ç¡®è®¤ Email OTP å·²åœ¨ Supabase ä¸­å¯ç”¨
- ç­‰å¾…å‡ åˆ†é’Ÿï¼Œé‚®ä»¶å¯èƒ½ä¼šå»¶è¿Ÿ
- Supabase å…è´¹å¥—é¤æ¯å°æ—¶æœ‰é‚®ä»¶å‘é€é™åˆ¶

### é—®é¢˜ 2: "Invalid API key" é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®è®¤ `.env` æ–‡ä»¶ä¸­çš„ `VITE_SUPABASE_ANON_KEY` æ­£ç¡®
- ç¡®ä¿å¤åˆ¶äº†å®Œæ•´çš„å¯†é’¥ï¼ˆé€šå¸¸å¾ˆé•¿ï¼‰
- é‡å¯å¼€å‘æœåŠ¡å™¨

### é—®é¢˜ 3: CORS é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
- åœ¨ Supabase é¡¹ç›®ä¸­ï¼Œè¿›å…¥ **Settings** -> **API**
- åœ¨ **Site URL** ä¸­æ·»åŠ ï¼š`http://localhost:3001`
- åœ¨ **Redirect URLs** ä¸­æ·»åŠ ï¼š`http://localhost:3001/**`

### é—®é¢˜ 4: ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆï¼š**
- ç¡®ä¿ç¯å¢ƒå˜é‡åä»¥ `VITE_` å¼€å¤´ï¼ˆè¿™æ˜¯ Vite çš„è¦æ±‚ï¼‰
- ä¿®æ”¹ `.env` åå¿…é¡»é‡å¯å¼€å‘æœåŠ¡å™¨
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å’Œé‡æ–°åŠ è½½é¡µé¢

## ğŸ“Š ä½¿ç”¨ Supabase Dashboard

### æŸ¥çœ‹ç”¨æˆ·

1. è¿›å…¥ Supabase é¡¹ç›®
2. ç‚¹å‡» ğŸ” **Authentication** -> **Users**
3. è¿™é‡Œå¯ä»¥çœ‹åˆ°æ‰€æœ‰æ³¨å†Œç”¨æˆ·
4. å¯ä»¥æ‰‹åŠ¨æ·»åŠ ã€åˆ é™¤æˆ–ç¼–è¾‘ç”¨æˆ·

### æŸ¥çœ‹æ—¥å¿—

1. ç‚¹å‡»å·¦ä¾§ ğŸ“Š **Logs**
2. é€‰æ‹©ä¸åŒçš„æ—¥å¿—ç±»å‹ï¼š
   - **Auth Logs**: è®¤è¯ç›¸å…³æ—¥å¿—
   - **API Logs**: API è¯·æ±‚æ—¥å¿—
   - **Realtime Logs**: å®æ—¶è®¢é˜…æ—¥å¿—

## ğŸ¨ è‡ªå®šä¹‰ç™»å½•ä½“éªŒ

ç™»å½•é¡µé¢å·²ç»è®¾è®¡å¥½ï¼Œä½äºï¼š`client/src/pages/login.tsx`

æ‚¨å¯ä»¥æ ¹æ®éœ€è¦è‡ªå®šä¹‰ï¼š
- Logo å’Œå“ç‰Œé¢œè‰²
- æ–‡æ¡ˆå’Œæç¤ºä¿¡æ¯
- æ·»åŠ æ›´å¤šè®¤è¯æ–¹å¼ï¼ˆGoogleã€GitHub ç­‰ï¼‰

## ğŸ”’ å®‰å…¨å»ºè®®

### ç”Ÿäº§ç¯å¢ƒé…ç½®

1. **ä½¿ç”¨ç”Ÿäº§ç¯å¢ƒä¸“ç”¨çš„ Supabase é¡¹ç›®**
   - ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¼€å‘ç¯å¢ƒçš„å¯†é’¥

2. **é…ç½® RLS (Row Level Security)**
   ```sql
   -- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
   ALTER TABLE patients ENABLE ROW LEVEL SECURITY;
   
   CREATE POLICY "Users can only see their own data"
   ON patients FOR SELECT
   USING (auth.uid() = user_id);
   ```

3. **é™åˆ¶ Email Rate Limiting**
   - åœ¨ Authentication -> Settings ä¸­é…ç½®
   - é˜²æ­¢æ¶æ„ç”¨æˆ·æ»¥ç”¨é‚®ä»¶å‘é€

4. **å¯ç”¨ 2FA for Admin**
   - ä¿æŠ¤æ‚¨çš„ Supabase ç®¡ç†è´¦æˆ·

## ğŸ“š æ›´å¤šèµ„æº

- [Supabase å®˜æ–¹æ–‡æ¡£](https://supabase.com/docs)
- [Supabase Auth æ–‡æ¡£](https://supabase.com/docs/guides/auth)
- [Supabase JavaScript å®¢æˆ·ç«¯](https://supabase.com/docs/reference/javascript/introduction)

## ğŸ†˜ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹æœ¬æŒ‡å—çš„æ•…éšœæ’æŸ¥éƒ¨åˆ†
2. è®¿é—® [Supabase Discord](https://discord.supabase.com)
3. æŸ¥çœ‹é¡¹ç›®çš„ GitHub Issues

---

**ç¥æ‚¨é…ç½®é¡ºåˆ©ï¼ğŸš€**
